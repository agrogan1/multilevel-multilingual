# Longitudinal Multilevel Models

```{r}
#| label: longitudinalsetup
#| echo: false
#| output: false

library(Statamarkdown)

library(lme4) 

library(JuliaCall)

julia_setup(JULIA_HOME = "/Applications/Julia-1.8.app/Contents/Resources/julia/bin")

```

## The Data

The data employed in these examples are a longitudinal extension of the data described in @sec-data.

## The Equation

$$\text{outcome}_{itj} = \beta_0 + \beta_1 \text{parental warmth}_{itj} + \beta_2 \text{physical punishment}_{itj} + \beta_3 \text{time}_{itj} \ + $$ {#eq-MLM-longitudinal} 

$$\beta_4 \text{identity}_{itj} + \beta_5 \text{intervention}_{itj} + \beta_6 \text{HDI}_{itj} +$$

$$u_{0j} + u_{1j} \times \text{parental warmth}_{itj} \ + $$

$$v_{0i} + v_{1i} \times \text{time}_{itj} + e_{itj}$$

## Run Models

::: {.panel-tabset group="language"}

### Stata

#### Get The Data 

```{stata, collectcode=TRUE}

use simulated_multilevel_longitudinal_data.dta

```

#### Run The Model

##### Main Effects Only

```{stata}

mixed outcome t warmth physical_punishment i.identity i.intervention HDI || country: warmth

```

##### Interactions With Time

```{stata}

mixed outcome c.t##(c.warmth c.physical_punishment i.identity i.intervention c.HDI) || country: warmth

```

### R

#### Get The Data

```{r}

library(haven)

dfL <- read_dta("simulated_multilevel_longitudinal_data.dta")

```

#### Run The Model

##### Main Effects Only

```{r}

fit2A <- lmer(outcome ~ t + warmth + physical_punishment + 
               identity + intervention + HDI +
               (1 | country/id),
             data = dfL)

summary(fit2A)

```

##### Interactions With Time

```{r}

fit2B <- lmer(outcome ~ t *(warmth + physical_punishment + 
               identity + intervention + HDI) +
               (1 | country/id),
             data = dfL)

summary(fit2B)

```


### Julia

#### Get The Data

```{julia}
#| output: false

using Tables, MixedModels, StatFiles, DataFrames, CategoricalArrays, DataFramesMeta

dfL = DataFrame(load("simulated_multilevel_longitudinal_data.dta"))

```

#### Run The Model

##### Change Country To Categorical

```{julia}
#| output: false

@transform!(dfL, :country = categorical(:country))

```

##### Main Effects Only

```{julia}

m2A = fit(MixedModel, @formula(outcome ~ t + warmth + 
                                 physical_punishment + 
                                 identity + intervention + 
                                 HDI +
                                 (1 | country) + 
                                 (0 + warmth | country) +
                                 (1 | id)), dfL)

```

##### Interactions With Time

```{julia}

m2B = fit(MixedModel, @formula(outcome ~ t * (warmth + 
                                 physical_punishment + 
                                 identity + intervention + 
                                   HDI) +
                                 (1 | country) +
                                 (0 + warmth | country) +
                                 (1 | id)), dfL)

```

:::

## Interpretation of Results

The *main effects only model* suggests that time is associated with increases in the outcome. In the main effects model, main effects other than time, indicate whether a particular variable is associated with higher or lower intercepts of the time trajectory, at the beginning of the study time. Warmth is again associated with increases in the outcome, while physical punishment is associated with decreases in the outcome. Identity is again not associated with the outcome, while the intervention is associated with higher levels of the outcome. The Human Development Index is again not associated with the outcome.

The second model adds interactions with time to the first model. Results are largly similar to the prior model. However, here we not only examine whether main effects other than time are associated with higher or lower time trajectories, but also whether particular variables are associated with differences in the slope of the time trajectory. In this case, we find that no independent variable is associated with changes in the slope of the time trajectory.

However, it may be illustrative to imagine how we would interpret the results had a particular interaction term been statistically significant. Let us consider one of the interaction terms with the largest coefficient, `intervention#time`. The interaction of the intervention with time is positive. Had this coefficient been statistically signifcant, it would have indicated that the intervention was associated with more rapid increases in the outcome over time *in addition to* the fact that the intervention is associated with higher initial levels of the outcome.








